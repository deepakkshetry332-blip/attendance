<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance Pro</title>
    
    <!-- Tailwind CSS (Aesthetics) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs (Google Cloud) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- Export Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        /* Pulse Animation */
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .btn-pulse { animation: pulse-green 2s infinite; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-white flex flex-col justify-center items-center p-6">
        <div class="text-center w-full max-w-sm">
            <div class="bg-indigo-100 p-5 rounded-full inline-flex mb-6">
                <i data-lucide="shield-check" class="w-12 h-12 text-indigo-600"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Attendance Pro</h1>
            <p class="text-gray-500 mb-8">Secure GPS & Device Locked System</p>
            
            <button onclick="handleGoogleLogin()" 
                    class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 text-gray-700 font-semibold py-4 rounded-xl shadow-sm hover:bg-gray-50 transition active:scale-95">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
                Sign in with Google
            </button>
            <p class="text-xs text-red-400 mt-4 hidden" id="device-lock-msg">
                üîí This device is locked to another user.
            </p>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div id="app-content" class="hidden flex-1 flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative">
        
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 p-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
            <div class="flex items-center gap-2">
                <img id="user-photo" src="" class="w-8 h-8 rounded-full border border-gray-200">
                <div>
                    <h2 class="font-bold text-sm text-gray-800" id="display-name">User</h2>
                    <p class="text-xs text-green-600 font-medium" id="current-class-display">Select Class</p>
                </div>
            </div>
            <button onclick="toggleSettings()" class="p-2 bg-gray-100 rounded-full hover:bg-gray-200">
                <i data-lucide="settings" class="w-5 h-5 text-gray-600"></i>
            </button>
        </header>

        <!-- Main Scroll -->
        <main class="flex-1 overflow-y-auto hide-scrollbar p-5 pb-32">
            
            <!-- Class Selector -->
            <div class="mb-6">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wide">Select Class</label>
                <select id="class-select" onchange="updateClassUI()" class="w-full mt-1 p-3 bg-gray-50 border border-gray-200 rounded-xl font-semibold text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="Class A">Class A (Morning)</option>
                    <option value="Class B">Class B (Afternoon)</option>
                    <option value="Lab Session">Lab Session</option>
                </select>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <!-- Check In -->
                <button onclick="handleAction('IN')" id="btn-in"
                    class="btn-pulse flex flex-col items-center justify-center p-6 bg-green-600 text-white rounded-2xl shadow-lg active:scale-95 transition">
                    <i data-lucide="log-in" class="w-8 h-8 mb-2"></i>
                    <span class="font-bold text-lg">Check In</span>
                    <span class="text-xs text-green-200 opacity-80">Enter Code</span>
                </button>

                <!-- Check Out -->
                <button onclick="handleAction('OUT')" id="btn-out"
                    class="flex flex-col items-center justify-center p-6 bg-red-500 text-white rounded-2xl shadow-lg opacity-50 cursor-not-allowed transition" disabled>
                    <i data-lucide="log-out" class="w-8 h-8 mb-2"></i>
                    <span class="font-bold text-lg">Check Out</span>
                    <span class="text-xs text-red-200 opacity-80">Before Leaving</span>
                </button>
            </div>

            <!-- Status Card -->
            <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-100 mb-8">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-indigo-400 uppercase">Current Status</span>
                    <span id="gps-indicator" class="text-xs bg-gray-200 px-2 py-1 rounded text-gray-500">GPS Off</span>
                </div>
                <h3 class="text-xl font-bold text-indigo-900" id="status-text">Not Checked In</h3>
                <p class="text-xs text-indigo-600 mt-1" id="time-log">--:--</p>
            </div>

            <!-- History Header -->
            <div class="flex justify-between items-end mb-4">
                <h3 class="font-bold text-gray-800">Today's Log</h3>
                <div class="flex gap-2">
                    <button onclick="exportData('xlsx')" class="p-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200"><i data-lucide="sheet" class="w-4 h-4"></i></button>
                    <button onclick="exportData('pdf')" class="p-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200"><i data-lucide="file-text" class="w-4 h-4"></i></button>
                </div>
            </div>

            <!-- History List -->
            <div id="history-list" class="space-y-3">
                <div class="text-center text-gray-400 text-sm py-4">Loading...</div>
            </div>

        </main>
    </div>

    <!-- ADMIN / SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">Admin Controls</h3>
                <button onclick="toggleSettings()" class="p-1 hover:bg-gray-100 rounded"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <div class="space-y-4">
                <!-- Admin PIN Entry -->
                <div id="admin-lock-screen">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Enter Admin PIN to Edit</label>
                    <input type="password" id="admin-pin-input" class="w-full p-3 border rounded-lg text-center tracking-widest text-xl" placeholder="****">
                    <button onclick="verifyAdmin()" class="w-full mt-3 bg-gray-800 text-white py-3 rounded-lg font-bold">Unlock Settings</button>
                </div>

                <!-- Protected Controls -->
                <div id="admin-controls" class="hidden space-y-4">
                    <div class="bg-blue-50 p-4 rounded-xl">
                        <label class="block text-xs font-bold text-blue-600 uppercase mb-2">1. Set Office Location</label>
                        <p class="text-xs text-gray-500 mb-2">Current: <span id="office-coords" class="font-mono">Loading...</span></p>
                        <button onclick="setOfficeLocation()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold">üìç Set My GPS as Office</button>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-xl">
                        <label class="block text-xs font-bold text-purple-600 uppercase mb-2">2. Daily Class Code</label>
                        <input type="text" id="daily-code-input" class="w-full p-2 border rounded mb-2 text-center font-mono font-bold" placeholder="e.g. 1234">
                        <button onclick="saveDailyCode()" class="w-full bg-purple-600 text-white py-2 rounded-lg text-sm font-semibold">üíæ Save Code</button>
                        <p class="text-[10px] text-gray-500 mt-2">Write this code on the board. Students must enter it to Check In.</p>
                    </div>

                    <div class="pt-2 border-t">
                        <button onclick="auth.signOut(); window.location.reload();" class="w-full text-red-600 py-2 text-sm font-bold">Log Out</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CODE ENTRY MODAL -->
    <div id="code-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-xs p-6 shadow-2xl text-center">
            <h3 class="font-bold text-lg mb-2">Anti-Bunking Check</h3>
            <p class="text-xs text-gray-500 mb-4">Enter the code written on the whiteboard.</p>
            <input type="number" id="student-code-input" class="w-full p-4 bg-gray-50 border-2 border-indigo-100 rounded-xl text-center text-2xl font-bold tracking-widest focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="0000">
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="document.getElementById('code-modal').classList.add('hidden')" class="py-3 text-gray-500 font-bold text-sm">Cancel</button>
                <button onclick="confirmCheckIn()" class="py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-lg">Verify</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl transition-all duration-300 opacity-0 translate-y-10 z-[60] flex items-center gap-2 min-w-max">
        <span id="toast-icon"></span>
        <span id="toast-message" class="text-sm font-medium">Notification</span>
    </div>

    <script>
        // ==========================================
        //  YOUR FIREBASE CONFIGURATION (CLEANED AND EMBEDDED)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBXk910-9A54W3tukJ3Yprc",
            authDomain: "attendance-cdb61.firebaseapp.com",
            projectId: "attendance-cdb61",
            storageBucket: "attendance-cdb61.appspot.com",
            messagingSenderId: "897353280226",
            appId: "1:897353280226:web:249a1c0634"
        };

        // ==========================================
        //  CONFIG
        // ==========================================
        const GEOFENCE_RADIUS = 100; // Meters
        const ADMIN_PIN = "1234";    // PIN to access settings/delete
        const APP_VERSION = "v2.0";

        // Init Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        let currentUser = null;
        let officeLocation = null;
        let dailyCode = null;
        let isAdminUnlocked = false;

        // ------------------------------------------------
        // 1. AUTH & DEVICE LOCK LOGIC
        // ------------------------------------------------
        function handleGoogleLogin() {
            // Device Lock Check
            const lockedEmail = localStorage.getItem('locked_email');
            
            auth.signInWithPopup(googleProvider).then((result) => {
                const email = result.user.email;
                
                // If device is locked to another email, reject
                if (lockedEmail && lockedEmail !== email) {
                    auth.signOut();
                    document.getElementById('device-lock-msg').classList.remove('hidden');
                    return;
                }

                // Lock device to this user
                localStorage.setItem('locked_email', email);
                initApp(result.user);
            }).catch(e => {
                // Check if error is 'auth/popup-closed-by-user'
                if (e.code === 'auth/popup-closed-by-user') {
                    showToast("Login cancelled.", 'info');
                } else {
                    showToast("Login Failed: Did you enable Google Auth in Firebase?", 'error');
                    console.error("Auth Error:", e);
                }
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                const lockedEmail = localStorage.getItem('locked_email');
                if (lockedEmail && lockedEmail !== user.email) {
                    auth.signOut(); // Kick out if mismatch
                } else {
                    localStorage.setItem('locked_email', user.email); // Ensure lock
                    initApp(user);
                }
            }
        });

        async function initApp(user) {
            currentUser = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            document.getElementById('display-name').innerText = user.displayName;
            document.getElementById('user-photo').src = user.photoURL || 'https://placehold.co/40x40/cccccc/333333?text=U';

            await loadSettings();
            updateClassUI(); // Calls checkTodayStatus internally
            loadHistory();
            lucide.createIcons();
        }

        // ------------------------------------------------
        // 2. CORE ATTENDANCE LOGIC
        // ------------------------------------------------
        
        let todayDocId = null;

        function updateClassUI() {
            const cls = document.getElementById('class-select').value;
            document.getElementById('current-class-display').innerText = cls;
            checkTodayStatus(); // Re-check status if class changes
        }

        function checkTodayStatus() {
            if (!currentUser) return;
            const dateStr = new Date().toLocaleDateString().replace(/\//g, '-');
            const cls = document.getElementById('class-select').value;
            
            // Check if record exists for User + Date + Class
            db.collection('attendance')
              .where('uid', '==', currentUser.uid)
              .where('dateId', '==', dateStr)
              .where('class', '==', cls)
              .get().then(snap => {
                  if (!snap.empty) {
                      const data = snap.docs[0].data();
                      todayDocId = snap.docs[0].id;
                      
                      if (data.checkOutTime) {
                          setStatusUI("COMPLETED", data.checkInTime, data.checkOutTime);
                      } else {
                          setStatusUI("CHECKED_IN", data.checkInTime);
                      }
                  } else {
                      todayDocId = null;
                      setStatusUI("FRESH");
                  }
              });
        }

        function setStatusUI(status, inTime, outTime) {
            const btnIn = document.getElementById('btn-in');
            const btnOut = document.getElementById('btn-out');
            const statusTxt = document.getElementById('status-text');
            const timeLog = document.getElementById('time-log');

            // Reset classes
            btnIn.classList.remove('opacity-50', 'cursor-not-allowed', 'btn-pulse');
            btnOut.classList.remove('opacity-50', 'cursor-not-allowed');

            if (status === "FRESH") {
                btnIn.disabled = false; btnIn.classList.add('btn-pulse');
                btnOut.disabled = true; btnOut.classList.add('opacity-50');
                statusTxt.innerText = "Ready to Check In";
                statusTxt.className = "text-xl font-bold text-indigo-900";
                timeLog.innerText = "Please select your class.";
            } else if (status === "CHECKED_IN") {
                btnIn.disabled = true; btnIn.classList.add('opacity-50', 'cursor-not-allowed');
                btnIn.classList.remove('btn-pulse');
                btnOut.disabled = false; 
                statusTxt.innerText = "Checked In ‚úÖ";
                statusTxt.className = "text-xl font-bold text-green-600";
                timeLog.innerText = `In: ${inTime}`;
            } else if (status === "COMPLETED") {
                btnIn.disabled = true; btnOut.disabled = true;
                btnIn.classList.add('opacity-50'); btnOut.classList.add('opacity-50');
                btnIn.classList.remove('btn-pulse');
                statusTxt.innerText = "Class Completed üéâ";
                statusTxt.className = "text-xl font-bold text-indigo-600";
                timeLog.innerText = `In: ${inTime} | Out: ${outTime}`;
            }
        }

        function handleAction(type) {
            if (!officeLocation) return showToast("‚ö†Ô∏è Admin: Set Office Location first", "error");
            if (document.getElementById('class-select').value === "") return showToast("Please select a class first.", "error");
            
            showToast("Acquiring GPS...", "info");
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDistance(pos.coords.latitude, pos.coords.longitude, officeLocation.lat, officeLocation.lng);
                
                document.getElementById('gps-indicator').innerText = `GPS: ¬±${Math.round(dist)}m`;

                if (dist > GEOFENCE_RADIUS) {
                    return showToast(`‚ùå Too far! You are ${Math.round(dist)}m away.`, "error");
                }

                if (type === 'IN') {
                    if (!dailyCode) return showToast("‚ùå Admin has not set the Daily Code yet.", "error");
                    document.getElementById('code-modal').classList.remove('hidden');
                } else {
                    processCheckOut();
                }

            }, err => showToast("GPS Error: Please enable location services.", "error"), {enableHighAccuracy: true});
        }

        // Called after code entry
        function confirmCheckIn() {
            const input = document.getElementById('student-code-input').value;
            if (input !== dailyCode) {
                return showToast("‚ùå Wrong Class Code! Ask Teacher.", "error");
            }
            
            document.getElementById('code-modal').classList.add('hidden');
            document.getElementById('student-code-input').value = ""; // Clear input
            processCheckIn();
        }

        async function processCheckIn() {
            const dateStr = new Date().toLocaleDateString().replace(/\//g, '-');
            const cls = document.getElementById('class-select').value;
            
            const record = {
                uid: currentUser.uid,
                name: currentUser.displayName,
                email: currentUser.email,
                class: cls,
                dateId: dateStr,
                checkInTime: new Date().toLocaleTimeString(),
                checkOutTime: null,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                locationVerified: true
            };

            try {
                await db.collection('attendance').add(record);
                showToast("Checked In Successfully!", "success");
                checkTodayStatus();
            } catch (e) {
                showToast("DB Save Error: " + e.message, "error");
            }
        }

        async function processCheckOut() {
            if (!todayDocId) return;
            
            try {
                await db.collection('attendance').doc(todayDocId).update({
                    checkOutTime: new Date().toLocaleTimeString()
                });
                showToast("Checked Out! Have a nice day.", "success");
                checkTodayStatus();
            } catch (e) {
                 showToast("DB Update Error: " + e.message, "error");
            }
        }

        // ------------------------------------------------
        // 3. ADMIN & SETTINGS
        // ------------------------------------------------
        
        async function loadSettings() {
            const doc = await db.collection('settings').doc('config').get();
            if (doc.exists) {
                const data = doc.data();
                officeLocation = data.location;
                dailyCode = data.dailyCode;
                document.getElementById('office-coords').innerText = officeLocation ? "Set ‚úÖ" : "Not Set";
                document.getElementById('daily-code-input').value = dailyCode || "";
            }
        }

        function verifyAdmin() {
            const pin = document.getElementById('admin-pin-input').value;
            if (pin === ADMIN_PIN) {
                isAdminUnlocked = true;
                document.getElementById('admin-lock-screen').classList.add('hidden');
                document.getElementById('admin-controls').classList.remove('hidden');
                showToast("Admin Unlocked", "success");
                loadHistory(); // Reload history to show delete buttons
            } else {
                showToast("Wrong PIN", "error");
            }
        }

        function setOfficeLocation() {
            navigator.geolocation.getCurrentPosition(async pos => {
                const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                await db.collection('settings').doc('config').set({ location: loc }, { merge: true });
                officeLocation = loc;
                document.getElementById('office-coords').innerText = "Updated Just Now ‚úÖ";
                showToast("Office Location Updated!", "success");
            }, (err) => showToast("GPS Error: " + err.message, "error"), {enableHighAccuracy: true});
        }

        async function saveDailyCode() {
            const code = document.getElementById('daily-code-input').value;
            await db.collection('settings').doc('config').set({ dailyCode: code }, { merge: true });
            dailyCode = code;
            showToast("Class Code Updated!", "success");
        }

        async function deleteRecord(id) {
            // Confirm is replaced by a safe custom modal in real PWA, but for simplicity:
            if (!confirm("Admin: Are you sure you want to delete this record?")) return; 
            try {
                await db.collection('attendance').doc(id).delete();
                showToast("Record Deleted", "success");
            } catch (e) {
                showToast("Delete Error: " + e.message, "error");
            }
        }

        // ------------------------------------------------
        // 4. HISTORY & UTILS
        // ------------------------------------------------

        function loadHistory() {
            const list = document.getElementById('history-list');
            
            db.collection('attendance').orderBy('timestamp', 'desc').limit(30)
              .onSnapshot(snap => {
                  list.innerHTML = '';
                  window.exportDataArr = []; 
                  
                  snap.forEach(doc => {
                      const d = doc.data();
                      
                      const exportRow = {
                          Name: d.name,
                          Email: d.email,
                          Class: d.class,
                          Date: d.dateId,
                          CheckIn: d.checkInTime,
                          CheckOut: d.checkOutTime || 'N/A',
                          Verified: d.locationVerified ? 'YES' : 'NO'
                      };
                      window.exportDataArr.push(exportRow);
                      
                      const deleteBtn = isAdminUnlocked 
                        ? `<button onclick="deleteRecord('${doc.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` 
                        : '';

                      const statusColor = d.checkOutTime ? 'text-indigo-500' : 'text-green-500';
                      const statusIcon = d.checkOutTime ? 'log-out' : 'log-in';

                      const html = `
                        <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                            <div>
                                <p class="font-bold text-gray-800">${d.name}</p>
                                <p class="text-xs text-gray-400">${d.class} ‚Ä¢ ${d.dateId}</p>
                                <p class="text-[10px] ${statusColor} mt-1 flex items-center"><i data-lucide="${statusIcon}" class="w-3 h-3 mr-1"></i> ${d.checkOutTime ? 'Completed' : 'Active'}</p>
                            </div>
                            <div class="text-right flex items-center gap-3">
                                <div>
                                    <p class="text-sm font-bold text-gray-700">IN: ${d.checkInTime}</p>
                                    <p class="text-xs text-red-400">OUT: ${d.checkOutTime || 'N/A'}</p>
                                </div>
                                ${deleteBtn}
                            </div>
                        </div>`;
                      list.innerHTML += html;
                  });
                  if (snap.empty) list.innerHTML = '<div class="text-center text-gray-400 py-10">No records today</div>';
                  lucide.createIcons();
              });
        }

        // Haversine
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function toggleSettings() {
            document.getElementById('settings-modal').classList.toggle('hidden');
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-10', 'bg-red-800', 'bg-green-800', 'bg-gray-800');
            t.classList.add(`bg-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'gray'}-800`);
            
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-10'), 3000);
        }

        function exportData(type) {
            if(!window.exportDataArr || window.exportDataArr.length === 0) return showToast("No Data", "error");
            
            if(type === 'xlsx') {
                const ws = XLSX.utils.json_to_sheet(window.exportDataArr);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Attendance");
                XLSX.writeFile(wb, "Attendance.xlsx");
                showToast("Excel Downloaded!", "success");
            } else {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const headers = ['Name', 'Class', 'Date', 'Check In', 'Check Out', 'Verified'];
                const rows = window.exportDataArr.map(d => [d.Name, d.Class, d.Date, d.CheckIn, d.CheckOut, d.Verified]);
                
                doc.autoTable({ head: [headers], body: rows, startY: 10 });
                doc.save("Attendance.pdf");
                showToast("PDF Downloaded!", "success");
            }
        }
    </script>
</body>
</html>

